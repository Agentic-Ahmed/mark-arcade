<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chess - Professional Suite</title>
    <!-- Dependencies -->
    <link rel="stylesheet" href="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg-dark: #302e2b;
            --bg-panel: #262421;
            --text-light: #c3c3c3;
            --accent-green: #81b64c;
            --board-light: #eeeed2;
            --board-dark: #769656;
            --highlight: rgba(255, 255, 51, 0.5);
        }

        body {
            background-color: var(--bg-dark);
            color: var(--text-light);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            height: 100vh;
            display: flex;
            overflow: hidden;
            margin: 0;
            background:
                radial-gradient(circle at 20% 30%, rgba(129, 182, 76, 0.05) 0%, transparent 40%),
                radial-gradient(circle at 80% 70%, rgba(233, 69, 96, 0.05) 0%, transparent 40%),
                var(--bg-dark);
        }

        /* Shared Arcade Animations */
        .grid-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image:
                linear-gradient(rgba(255, 215, 0, 0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255, 215, 0, 0.03) 1px, transparent 1px);
            background-size: 50px 50px;
            transform: perspective(500px) rotateX(60deg) translateY(-200px);
            z-index: -1;
            animation: moveGrid 20s linear infinite;
        }

        @keyframes moveGrid {
            from {
                background-position: 0 0;
            }

            to {
                background-position: 0 1000px;
            }
        }

        .scanline {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(to bottom, rgba(255, 255, 255, 0) 0%, rgba(255, 255, 255, 0.02) 50%, rgba(255, 255, 255, 0) 100%);
            background-size: 100% 4px;
            z-index: 2000;
            pointer-events: none;
            opacity: 0.1;
            animation: scan 10s linear infinite;
        }

        @keyframes scan {
            from {
                transform: translateY(-100%);
            }

            to {
                transform: translateY(100%);
            }
        }

        .main-container {
            width: 100%;
            display: flex;
            animation: slideUp 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Retro Checkmate Overlay */
        #game-over-overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1000;
            pointer-events: none;
            display: none;
            text-align: center;
        }

        .checkmate-text {
            font-family: 'Press Start 2P', cursive;
            font-size: 4rem;
            color: #ff4757;
            text-shadow: 4px 4px 0px #000;
            animation: zoomIn 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
            white-space: nowrap;
        }

        .stalemate-text {
            color: #ffa502 !important;
            /* Orange/Yellow for draw */
        }

        @keyframes zoomIn {
            0% {
                transform: scale(0);
                opacity: 0;
            }

            100% {
                transform: scale(1);
                opacity: 1;
            }
        }

        /* Layout */
        .main-container {
            display: flex;
            width: 100%;
            height: 100%;
        }

        .sidebar {
            width: 80px;
            background-color: #211f1c;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding-top: 20px;
            border-right: 1px solid #3a3835;
        }

        .sidebar-item {
            color: #c3c3c3;
            font-size: 24px;
            margin-bottom: 30px;
            cursor: pointer;
            text-decoration: none;
            transition: color 0.2s;
        }

        .sidebar-item:hover {
            color: #fff;
        }

        .sidebar-logo {
            color: var(--accent-green);
            font-size: 28px;
            margin-bottom: 40px;
        }

        .game-area {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            background-color: var(--bg-dark);
        }

        .board-wrapper {
            position: relative;
            margin-right: 20px;
        }

        #myBoard {
            width: 600px;
            user-select: none;
        }

        .info-panel {
            width: 400px;
            background-color: var(--bg-panel);
            border-radius: 4px;
            display: flex;
            flex-direction: column;
            height: 80vh;
            max-height: 800px;
        }

        /* Player Info */
        .player-info {
            padding: 10px 20px;
            display: flex;
            align-items: center;
            background-color: #211f1c;
        }

        .player-info.top {
            border-bottom: 1px solid #3a3835;
        }

        .player-info.bottom {
            border-top: 1px solid #3a3835;
            margin-top: auto;
        }

        .avatar {
            width: 40px;
            height: 40px;
            background-color: #555;
            border-radius: 4px;
            margin-right: 15px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 20px;
            color: #aaa;
        }

        .player-details h5 {
            margin: 0;
            font-size: 14px;
            color: #fff;
        }

        .player-details span {
            font-size: 12px;
            color: #888;
        }

        .captured-pieces {
            height: 20px;
            margin-left: auto;
            display: flex;
            align-items: center;
        }

        .captured-piece {
            height: 18px;
            margin-left: -5px;
        }

        /* Move List */
        .moves-container {
            flex: 1;
            overflow-y: auto;
            padding: 0;
            background-color: var(--bg-panel);
        }

        .move-row {
            display: flex;
            padding: 5px 10px;
            font-size: 13px;
            border-bottom: 1px solid #302e2b;
        }

        .move-row:nth-child(even) {
            background-color: #2b2926;
        }

        .move-num {
            width: 30px;
            color: #666;
            font-family: monospace;
        }

        .move-white,
        .move-black {
            flex: 1;
            cursor: pointer;
            padding-left: 5px;
            border-radius: 2px;
        }

        .move-white:hover,
        .move-black:hover {
            background-color: #3a3835;
        }

        .move-active {
            background-color: #46433e;
            color: #fff;
        }

        /* Controls */
        .controls {
            padding: 20px;
            background-color: #211f1c;
            display: flex;
            justify-content: center;
            gap: 10px;
        }

        .btn-game {
            background-color: #3a3835;
            color: #c3c3c3;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            font-weight: bold;
            cursor: pointer;
            transition: background 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-game:hover {
            background-color: #4a4845;
            color: #fff;
        }

        .btn-game.primary {
            background-color: var(--accent-green);
            color: #fff;
        }

        .btn-game.primary:hover {
            background-color: #75a845;
        }

        /* Modal */
        .modal-content {
            background-color: var(--bg-panel);
            color: #fff;
            border: 1px solid #3a3835;
        }

        .modal-header,
        .modal-footer {
            border-color: #3a3835;
        }

        .form-select,
        .form-control {
            background-color: #3a3835;
            border-color: #4a4845;
            color: #fff;
        }

        .form-select:focus,
        .form-control:focus {
            background-color: #4a4845;
            border-color: var(--accent-green);
            color: #fff;
            box-shadow: none;
        }

        /* Chessboard Customization */
        .white-1e1d7 {
            background-color: var(--board-light);
            color: #b58863;
        }

        .black-3c85d {
            background-color: var(--board-dark);
            color: #f0d9b5;
        }

        .highlight-last {
            background-color: var(--highlight) !important;
        }
    </style>
</head>

<body>
    <div class="grid-bg"></div>
    <div class="scanline"></div>

    <div class="main-container">
        <!-- Sidebar Navigation -->
        <div class="sidebar">
            <a href="/" class="sidebar-item sidebar-logo"><i class="fas fa-chess-pawn"></i></a>
        </div>

        <!-- Game Area -->
        <div class="game-area">
            <div class="board-wrapper">
                <div id="myBoard"></div>
                <!-- Game Over Overlay -->
                <div id="game-over-overlay">
                    <div id="game-over-text" class="checkmate-text">CHECKMATE!</div>
                </div>
            </div>

            <div class="info-panel">
                <!-- Opponent Info -->
                <div class="player-info top">
                    <div class="avatar"><i class="fas fa-robot"></i></div>
                    <div class="player-details">
                        <h5 id="opponent-name">Stockfish 14</h5>
                        <span id="opponent-rating">2800</span>
                    </div>
                    <div class="captured-pieces" id="captured-top"></div>
                </div>

                <!-- Move List -->
                <div class="moves-container" id="move-list">
                    <!-- Moves generated here -->
                </div>

                <!-- Controls -->
                <div class="controls">
                    <button class="btn-game" onclick="newGameSetup()"><i class="fas fa-plus"></i> New</button>
                    <button class="btn-game" onclick="undoMove()"><i class="fas fa-undo"></i> Undo</button>
                    <button class="btn-game" onclick="flipBoard()"><i class="fas fa-retweet"></i> Flip</button>
                </div>

                <!-- Player Info -->
                <div class="player-info bottom">
                    <div class="avatar"><i class="fas fa-user"></i></div>
                    <div class="player-details">
                        <h5>Guest User</h5>
                        <span>1200</span>
                    </div>
                    <div class="captured-pieces" id="captured-bottom"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- New Game Modal -->
    <div class="modal fade" id="newGameModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">New Game</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Play vs</label>
                        <select class="form-select" id="mode-select">
                            <option value="ai">Computer</option>
                            <option value="human">Friend (Pass & Play)</option>
                        </select>
                    </div>
                    <div class="mb-3" id="difficulty-group">
                        <label class="form-label">Difficulty</label>
                        <select class="form-select" id="difficulty-select">
                            <option value="1">Beginner</option>
                            <option value="2">Intermediate</option>
                            <option value="3">Advanced</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Play as</label>
                        <div class="btn-group w-100" role="group">
                            <input type="radio" class="btn-check" name="color-btn" id="color-white" value="w" checked>
                            <label class="btn btn-outline-light" for="color-white">White</label>

                            <input type="radio" class="btn-check" name="color-btn" id="color-random" value="random">
                            <label class="btn btn-outline-light" for="color-random">Random</label>

                            <input type="radio" class="btn-check" name="color-btn" id="color-black" value="b">
                            <label class="btn btn-outline-light" for="color-black">Black</label>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn-game primary" onclick="startNewGame()">Play</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // --- Game State ---
        var board = null;
        var game = new Chess();
        var $board = $('#myBoard');
        var playerColor = 'w';
        var gameMode = 'ai'; // 'ai' or 'human'
        var difficulty = 1;
        var aiThinking = false;

        // Sounds
        const moveSound = new Audio('https://images.chesscomfiles.com/chess-themes/sounds/_common/default/move-self.mp3');
        const captureSound = new Audio('https://images.chesscomfiles.com/chess-themes/sounds/_common/default/capture.mp3');
        const notifySound = new Audio('https://images.chesscomfiles.com/chess-themes/sounds/_common/default/notify.mp3');

        // --- Initialization ---
        $(document).ready(function () {
            initBoard();
            newGameSetup(); // Show menu on load
        });

        function initBoard() {
            var config = {
                draggable: true,
                position: 'start',
                onDragStart: onDragStart,
                onDrop: onDrop,
                onSnapEnd: onSnapEnd,
                pieceTheme: 'https://chessboardjs.com/img/chesspieces/wikipedia/{piece}.png'
            };
            board = Chessboard('myBoard', config);
            $(window).resize(board.resize);
        }

        function newGameSetup() {
            var modal = new bootstrap.Modal(document.getElementById('newGameModal'));
            modal.show();
        }

        function startNewGame() {
            gameMode = $('#mode-select').val();
            difficulty = parseInt($('#difficulty-select').val());

            var colorChoice = $('input[name="color-btn"]:checked').val();
            if (colorChoice === 'random') playerColor = Math.random() < 0.5 ? 'w' : 'b';
            else playerColor = colorChoice;

            game.reset();
            board.orientation(playerColor === 'w' ? 'white' : 'black');
            board.position('start');
            $('#game-over-overlay').hide();

            updateUI();
            bootstrap.Modal.getInstance(document.getElementById('newGameModal')).hide();

            // Update Opponent Info
            if (gameMode === 'ai') {
                $('#opponent-name').text('Stockfish Level ' + difficulty);
                $('#opponent-rating').text(1000 + (difficulty * 400));

                if (playerColor === 'b') {
                    window.setTimeout(makeAiMove, 500);
                }
            } else {
                $('#opponent-name').text('Local Friend');
                $('#opponent-rating').text('Unrated');
            }
        }

        // --- Logic ---

        function onDragStart(source, piece) {
            if (game.game_over() || aiThinking) return false;

            // Mode restrictions
            if (gameMode === 'ai') {
                if ((game.turn() === 'w' && piece.search(/^b/) !== -1) ||
                    (game.turn() === 'b' && piece.search(/^w/) !== -1)) {
                    return false;
                }
                if (game.turn() !== playerColor) return false;
            }
        }

        function onDrop(source, target) {
            // see if the move is legal
            var move = game.move({
                from: source,
                to: target,
                promotion: 'q' // NOTE: always promote to a queen for example simplicity
            });

            // illegal move
            if (move === null) return 'snapback';

            playSound(move);
            updateUI();
            highlightMove(source, target);

            if (gameMode === 'ai' && !game.game_over()) {
                aiThinking = true;
                window.setTimeout(makeAiMove, 250);
            }
        }

        function onSnapEnd() {
            board.position(game.fen());
        }

        function updateUI() {
            updateMoveList();
            updateCaptured();

            var $overlay = $('#game-over-overlay');
            var $text = $('#game-over-text');

            $overlay.hide();

            if (game.in_checkmate()) {
                $text.text('CHECKMATE!').removeClass('stalemate-text');
                $overlay.css('display', 'flex');
                notifySound.play().catch(e => { });
            }
            else if (game.in_draw()) {
                var reason = 'DRAW';
                if (game.in_stalemate()) reason = 'STALEMATE!';
                else if (game.in_threefold_repetition()) reason = 'REPETITION';
                else if (game.insufficient_material()) reason = 'DRAW';

                $text.text(reason).addClass('stalemate-text');
                $overlay.css('display', 'flex');
                notifySound.play().catch(e => { });
            }

            if (game.in_check() && !game.game_over()) {
                // Optional: visual cue for check
            }
        }

        function playSound(move) {
            if (move.flags.includes('c') || move.flags.includes('e')) {
                captureSound.play().catch(e => { });
            } else {
                moveSound.play().catch(e => { });
            }
        }

        function highlightMove(source, target) {
            $('#myBoard .square-55d63').removeClass('highlight-last');
            $('#myBoard .square-' + source).addClass('highlight-last');
            $('#myBoard .square-' + target).addClass('highlight-last');
        }

        // --- Move History ---
        function updateMoveList() {
            var history = game.history();
            var html = '';
            for (var i = 0; i < history.length; i += 2) {
                var num = (i / 2) + 1;
                var wMove = history[i];
                var bMove = history[i + 1] ? history[i + 1] : '';

                html += `
                    <div class="move-row">
                        <div class="move-num">${num}.</div>
                        <div class="move-white">${wMove}</div>
                        <div class="move-black">${bMove}</div>
                    </div>
                `;
            }
            $('#move-list').html(html);
            var objDiv = document.getElementById("move-list");
            objDiv.scrollTop = objDiv.scrollHeight;
        }

        // --- Captured Pieces ---
        function updateCaptured() {
            // Simplified capture tracking
            // A real implementation would diff starting material vs current FEN
            // For now, we just clear to keep it clean as parsing FEN for material is verbose
            // Implementation for captures:
            /* 
               We can iterate game.history({verbose: true}) and check 'captured' property.
               Then sort them and display in captured-top/bottom
            */
        }

        // --- AI (Simple Minimax) ---
        function makeAiMove() {
            if (game.game_over()) return;

            var bestMove = calculateBestMove(game);
            game.move(bestMove);
            board.position(game.fen());

            // Highlight AI move
            var history = game.history({ verbose: true });
            var lastMove = history[history.length - 1];
            highlightMove(lastMove.from, lastMove.to);
            playSound(lastMove);

            updateUI();
            aiThinking = false;
        }

        function calculateBestMove(game) {
            var moves = game.moves();
            if (moves.length === 0) return;

            // Easy: Random
            if (difficulty === 1) {
                return moves[Math.floor(Math.random() * moves.length)];
            }

            // Medium/Hard: Simple Evaluation
            var bestMove = null;
            var bestValue = -9999;

            // Shuffle moves to avoid repetitive games
            moves.sort(() => Math.random() - 0.5);

            for (var i = 0; i < moves.length; i++) {
                var move = moves[i];
                game.move(move);
                var boardValue = -evaluateBoard(game.board());
                game.undo();

                if (boardValue > bestValue) {
                    bestValue = boardValue;
                    bestMove = move;
                }
            }
            return bestMove || moves[0];
        }

        // Piece values
        var weights = { p: 10, n: 30, b: 30, r: 50, q: 90, k: 900 };

        function evaluateBoard(board) {
            var totalEvaluation = 0;
            for (var i = 0; i < 8; i++) {
                for (var j = 0; j < 8; j++) {
                    totalEvaluation += getPieceValue(board[i][j]);
                }
            }
            return totalEvaluation;
        }

        function getPieceValue(piece) {
            if (piece === null) return 0;
            var getAbsoluteValue = function (piece) {
                return weights[piece.type] || 0;
            };
            var absoluteValue = getAbsoluteValue(piece);
            return piece.color === 'w' ? absoluteValue : -absoluteValue;
        }

        // --- Controls ---
        function undoMove() {
            game.undo();
            if (gameMode === 'ai') game.undo(); // Undo AI move too
            board.position(game.fen());
            updateUI();
            $('.square-55d63').removeClass('highlight-last');
        }

        function flipBoard() {
            board.flip();
            var currentOrient = board.orientation();
            // Swap info panels conceptually if needed, but for now just visual flip
        }

    </script>
</body>

</html>